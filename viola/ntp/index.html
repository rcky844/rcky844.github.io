<!-- html stuffs -->
<title>New tab</title>
<link rel="icon" href="../assets/logo.png">

<!-- styles -->
<style>
body {
    font-family:  "Helvetica Neue", Helvetica, Arial, sans-serif;
    text-align: center;
    margin-top: 20%;
}

dialog {
    text-align: left;
}

input[type=text] {
    width: 45%;
    background-color: #66666666;
    font-size: 18px;
    border-radius: 28px;
    border: none;
    padding: 16px 32px;
    margin: 32px 8px;
    box-shadow: 0 1px 2px 0 rgba(0,0,0,.15);
}

input[type=text]:focus {
    outline: none;
    background-color: #88888888;
    box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
}

button[type="submit"] {
    background-color: #66666666;
    border-radius: 28px;
    border: none;
    display: inline-block;
    cursor: pointer;
    padding: 16px;
    margin: 32px 8px;
    box-shadow: 0 1px 2px 0 rgba(0,0,0,.15);
}

button[type="submit"]:hover {
    background-color: #88888888;
    box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
}

.button-settings {
    background-color: #00000000;
    border-radius: 28px;
    border: none;
    display: inline-block;
    cursor: pointer;
    padding: 16px;
    margin: 0px 8px;
}

.button-settings:hover {
    background-color: #88888888;
}

.button-topright-container {
    position: absolute;
    top: 0px;
    right: 0px;
    margin: 16px;
}

.input-container {
    display: flex;
    justify-content: center;
}

#engine-select {
    cursor: pointer;
    width: 100%;
    position: relative;
    text-align: left;
    font-family:  "Helvetica Neue", Helvetica, Arial, sans-serif;
    background-color: #66666666;
    outline: none;
    border: none;
    padding: 18px;
}
</style>

<!-- scripts -->
<script src="engines.js"></script>
<script>
var enginesIdentifier;
var enginesName = [];

// Extracted from Viola Browser as of 31 July, 2024
const protocolRegex = "^(?:[a-z+]+:)?//" // ntp specific
const httpUrlRegex = "https?://(www\\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_+.~#?&\\\\=]*)(/.*)?"

function loadEngines() {
    var engineSelect = document.getElementById('engine-select');

    enginesIdentifier = Object.keys(engines);
    enginesIdentifier.forEach((element) => {
        if (localStorage.getItem('ntp-engine') == undefined) {
            // We expect only one engine be default
            if (engines[element].default == true) {
                localStorage.setItem('ntp-engine', element);
            }
        }
        enginesName.push(engines[element].name);

        // Populate the select list
        var engineOption = document.createElement('option');
        engineOption.value = element;
        engineOption.innerHTML = engines[element].name;
        engineSelect.appendChild(engineOption);
    });
}

function setEngine(selectObject) {
    localStorage.setItem('ntp-engine', selectObject.value);
}

function triggerHome() {
    if (localStorage.getItem('ntp-engine') == undefined) loadEngines();

    var engineObject = engines[localStorage.getItem('ntp-engine')];
    window.location = engineObject.homePage;
}

function triggerSearch() {
    if (localStorage.getItem('ntp-engine') == undefined) loadEngines();

    var engineObject = engines[localStorage.getItem('ntp-engine')];
    var query = document.getElementById('search-input').value;
    var finalUrl = query;

    if (query.length <= 0) return;
    if (!query.match(protocolRegex)) { // is relative
        finalUrl = "https://" + query; // TODO: Allow switching to http
    }
    if (!finalUrl.match(httpUrlRegex)) {
        finalUrl = engineObject.search;
        finalUrl = finalUrl.replace(homePagePlaceholder, engineObject.homePage);
        finalUrl = finalUrl.replace(queryPlaceholder, query);
        finalUrl = finalUrl.replace(languagePlaceholder, navigator.language || navigator.userLanguage);
    }
    window.location = finalUrl;
}

function openSettings() {
    const element = document.getElementById('settings-dialog');
    element.showModal();

    setDefaultsFromStorage();
}

function closeSettings() {
    var element = document.getElementById('settings-dialog');
    element.close();
}

function setDefaultsFromStorage() {
    // Set the selector to default engine
    var engineSelect = document.getElementById('engine-select');
    engineSelect.value = localStorage.getItem('ntp-engine');

    // Set the value for hide-home
    var engineSelect = document.getElementById('hide-home');
    engineSelect.checked = localStorage.getItem('ntp-hide-home');
    updateHideHome(engineSelect.checked);
}

function updateHideHome(value) {
    // Update hide-home
    var homeButton = document.getElementById("home");
    if (value) {
        homeButton.style.visibility = "hidden";
    } else {
        homeButton.style.visibility = "visible";
    }
}

/* Mobile dynamic styles */
function detectMobile() {
   return window.innerWidth <= 800 || window.innerHeight <= 600;
}

function fixInputContainerForMobile() {
    if (detectMobile()) {
        const searchButton = document.getElementById("search");
        searchButton.remove();

        const inputbox = document.getElementById('search-input');
        inputbox.style.width = "80%";
    }
}

window.onload = function() {
    loadEngines();
    setDefaultsFromStorage();
    fixInputContainerForMobile();

    // Setup search input box for enter key presses
    var inputbox = document.getElementById('search-input');
    inputbox.addEventListener('keydown', (event) => {
        if (event.key === "Enter") {
            triggerSearch();
            return false;
        }
    });

    // Setup hide-home checkbox listener
    var hideHome = document.getElementById('hide-home');
    hideHome.addEventListener('change', (event) => {
        updateHideHome(event.currentTarget.checked);
        localStorage.setItem('ntp-hide-home', event.currentTarget.checked);
    });
}
</script>

<!-- content -->
<body>
<div class="button-topright-container">
<button id="home" class="button-settings" onclick="triggerHome()"><img src="../assets/home.svg"></img></button>
<button id="settings" class="button-settings" onclick="openSettings()"><img src="../assets/settings.svg"></img></button>
</div>

<div class="logo-container">
<h2><img style="vertical-align: middle;" src="../assets/logo.png"> Viola Browser</h2>
</div>

<div class="input-container">
<input id="search-input" type="text" placeholder="Search or type web addressâ€¦">
<button id="search" type="submit" onclick="triggerSearch()"><img src="../assets/search.svg"></img></button>
</div>

<dialog id="settings-dialog" style="width: 50%;">
<h2>Settings</h2>

<h3>Search Engine</h3>
<select id="engine-select" onchange="setEngine(this)"></select>

<h3>Visuals</h3>
<input type="checkbox" id="hide-home" value="hide-home">
<label for="hide-home"> Hide home button</label><br>

<div style="display: flex; justify-content: center;"><button type="submit" class="button_settings" onclick="closeSettings()"><img src="../assets/close.svg"></img></a></div>
</dialog>
</body>
